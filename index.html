<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PAV+ Luxury Villa</title>

<style>
:root{
--gold:#d4af37;
--bg:#0b0b0b;
--glass:rgba(255,255,255,0.05);
}

*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,sans-serif}

body{
background:radial-gradient(circle at 20% 20%, rgba(212,175,55,0.05), transparent 40%),
radial-gradient(circle at 80% 80%, rgba(212,175,55,0.05), transparent 40%),
#000;
color:#fff;
overflow-x:hidden;
}

/* SPLASH */
#splash{
position:fixed;
inset:0;
background:#000;
display:flex;
flex-direction:column;
justify-content:center;
align-items:center;
z-index:999;
animation:fadeOut 1s forwards 2.5s;
}
@keyframes fadeOut{to{opacity:0;visibility:hidden}}

.logo{
width:160px;
filter:drop-shadow(0 0 20px var(--gold));
animation:float 3s ease-in-out infinite alternate;
}
@keyframes float{from{transform:translateY(0)}to{transform:translateY(-10px)}}

/* LOCK */
#lock{
position:fixed;
inset:0;
background:#000;
display:flex;
flex-direction:column;
align-items:center;
justify-content:center;
gap:20px;
z-index:998;
}

.keypad{
display:grid;
grid-template-columns:repeat(3,70px);
gap:15px;
}

.key{
height:70px;
border-radius:50%;
background:#111;
display:flex;
align-items:center;
justify-content:center;
font-size:20px;
border:1px solid #222;
}
.key:active{background:var(--gold);color:#000}

/* APP */
#app{display:none;padding:20px;padding-bottom:60px}

.card{
background:var(--glass);
backdrop-filter:blur(10px);
padding:20px;
border-radius:20px;
margin-bottom:20px;
border:1px solid rgba(212,175,55,.2);
}

.button{
background:var(--gold);
color:#000;
padding:6px 14px;
border-radius:20px;
display:inline-block;
margin-top:8px;
cursor:pointer;
}

input, select{
width:100%;
padding:8px;
margin-top:6px;
background:#111;
border:1px solid #222;
color:#fff;
border-radius:10px;
}

.device-card{
margin-top:15px;
padding:15px;
border-radius:15px;
background:#111;
border:1px solid rgba(212,175,55,.2);
}

.log-item{
font-size:12px;
margin-bottom:4px;
opacity:.8;
}
</style>
</head>
<body>

<div id="splash">
<img src="logo.png" class="logo">
<h2 style="color:#d4af37;margin-top:15px;">PAV+</h2>
</div>

<div id="lock">
<h3 style="color:#d4af37;">Wpisz PIN</h3>
<div class="keypad">
<div class="key">1</div><div class="key">2</div><div class="key">3</div>
<div class="key">4</div><div class="key">5</div><div class="key">6</div>
<div class="key">7</div><div class="key">8</div><div class="key">9</div>
<div></div><div class="key">0</div><div class="key" id="del">B</div>
</div>
</div>

<div id="app">

<div class="card">
<h3>Dodaj urządzenie Tasmota</h3>
<input id="devName" placeholder="Nazwa">
<input id="devIP" placeholder="IP np. 192.168.1.50">
<div class="button" onclick="addDevice()">Dodaj</div>
</div>

<div id="devices"></div>

<div class="card">
<h3>Log systemowy</h3>
<div class="button" onclick="exportLogs()">Eksport</div>
<div id="log"></div>
</div>

</div>

<script>
let failedAttempts=0;
let lockUntil=0;

/* SHA-256 */
async function hash(text){
const enc=new TextEncoder();
const buf=await crypto.subtle.digest("SHA-256",enc.encode(text));
return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}

async function initPIN(){
if(!localStorage.getItem("pav_pin")){
localStorage.setItem("pav_pin",await hash("1111"));
}
}
initPIN();

let pinInput="";
document.querySelectorAll(".key").forEach(k=>{
k.onclick=async()=>{
if(Date.now()<lockUntil) return alert("Zablokowany 60s");
if(k.innerText==="B"){pinInput=pinInput.slice(0,-1)}
else if(pinInput.length<4){pinInput+=k.innerText}
if(pinInput.length===4){
let h=await hash(pinInput);
if(h===localStorage.getItem("pav_pin")){
unlock();
}else{
failedAttempts++;
logEvent("Błędny PIN","system");
if(failedAttempts>=5){
lockUntil=Date.now()+60000;
alert("Blokada 60s");
}
}
pinInput="";
}
}
});

function unlock(){
document.getElementById("lock").style.display="none";
document.getElementById("app").style.display="block";
logEvent("Odblokowano system","system");
startAutoLock();
loadDevices();
renderLogs();
}

function startAutoLock(){
setTimeout(()=>location.reload(),300000);
document.addEventListener("visibilitychange",()=>{
if(document.hidden) location.reload();
});
}

/* LOG */
function logEvent(text,type){
let logs=JSON.parse(localStorage.getItem("pav_logs")||"[]");
logs.unshift({time:new Date().toLocaleString(),text,type});
if(logs.length>300) logs=logs.slice(0,300);
localStorage.setItem("pav_logs",JSON.stringify(logs));
renderLogs();
}

function renderLogs(){
let logs=JSON.parse(localStorage.getItem("pav_logs")||"[]");
let el=document.getElementById("log");
el.innerHTML="";
logs.forEach(l=>{
let div=document.createElement("div");
div.className="log-item";
div.innerText=l.time+" - "+l.text;
el.appendChild(div);
});
}

function exportLogs(){
let data=localStorage.getItem("pav_logs")||"[]";
let blob=new Blob([data],{type:"text/plain"});
let a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="logs.txt";
a.click();
}

/* TASMOTA DEVICES */
function addDevice(){
let name=document.getElementById("devName").value;
let ip=document.getElementById("devIP").value;
if(!name||!ip) return;

let devices=JSON.parse(localStorage.getItem("pav_devices")||"[]");
devices.push({id:Date.now(),name,ip,scenes:[]});
localStorage.setItem("pav_devices",JSON.stringify(devices));
loadDevices();
logEvent("Dodano urządzenie "+name,"tasmota");
}

function loadDevices(){
let devices=JSON.parse(localStorage.getItem("pav_devices")||"[]");
let container=document.getElementById("devices");
container.innerHTML="";
devices.forEach(d=>{
let div=document.createElement("div");
div.className="device-card";
div.innerHTML=`
<h4>${d.name}</h4>
<div>Status: <span id="status-${d.id}">...</span></div>
<div class="button" onclick="power('${d.ip}','On')">ON</div>
<div class="button" onclick="power('${d.ip}','Off')">OFF</div>
<input type="range" min="0" max="100" onchange="setDimmer('${d.ip}',this.value)">
<input type="color" onchange="setColor('${d.ip}',this.value)">
`;
container.appendChild(div);
checkStatus(d);
setInterval(()=>checkStatus(d),5000);
});
}

async function power(ip,state){
await fetch(`http://${ip}/cm?cmnd=Power%20${state}`);
logEvent("Power "+state+" "+ip,"tasmota");
}

async function setDimmer(ip,val){
await fetch(`http://${ip}/cm?cmnd=Dimmer%20${val}`);
logEvent("Dimmer "+val+" "+ip,"tasmota");
}

async function setColor(ip,val){
let hex=val.replace("#","");
await fetch(`http://${ip}/cm?cmnd=Color%20${hex}`);
logEvent("Color "+hex+" "+ip,"tasmota");
}

async function checkStatus(d){
try{
let r=await fetch(`http://${d.ip}/cm?cmnd=Status%200`);
let json=await r.json();
let power=json.Status.Power||json.StatusSTS.POWER;
document.getElementById("status-"+d.id).innerText=power;
}catch(e){
document.getElementById("status-"+d.id).innerText="Offline";
}
}
</script>

</body>
</html>
